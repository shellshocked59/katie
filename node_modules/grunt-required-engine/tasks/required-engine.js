module.exports = function(grunt) {
    'use strict';
    
    grunt.registerMultiTask('requiredEngine', '', function() {
        var _ = require( 'underscore' );
        var options = {};
        var rengine = {};
        var pjson;
        
        rengine = require('../lib/required-engine');
        pjson = grunt.file.readJSON( 'package.json' ) || {};
        
        options = {
            includeDev: this.options().includeDev || false
          , writeOnPackage: this.options().writeOnPackage || false
        };
        
        (function (options, packageJson) {
            var engine;
            
            function _getDependencies( packageJson, includeDev ) {
                var dependencies = [];
                
                dependencies = _.keys( packageJson.dependencies || {} );
                   
                if( includeDev ) {
                    dependencies = _.union( _.keys( packageJson.devDependencies || {} ), dependencies );
                }
                
                return dependencies;
            }
            
            function _getNodeEngine() {
                var dependencies;
                var engine='';
                
                dependencies = _getDependencies( packageJson, options.includeDev );
                rengine.init(dependencies);
                engine+= rengine.getLatestVersion();
                engine+= rengine.getGreatestVersion();
                
                return engine;
            }
            
            engine = { node: _getNodeEngine() || '' };
            
            if(options.writeOnPackage) {
                packageJson.engine = engine;
                grunt.file.write('package.json', JSON.stringify(packageJson, null, 4));
            }
            
            grunt.log.writeln();
            grunt.log.writeln('---------------------------');
            grunt.log.writeln('-  required node version  -');
            grunt.log.writeln('---------------------------');
            grunt.log.writeln('- ', engine);
            grunt.log.writeln('---------------------------');
            grunt.log.writeln();
            
        })(options, pjson);
        
    });   
}
